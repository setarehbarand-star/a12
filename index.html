<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§ÙØ²Ø§ÛŒØ´ ÙˆÙ‚ÙÙ‡â€ŒÙ‡Ø§ÛŒ ØµÙˆØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù„Ø§Ú¯ÙˆÛŒÛŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            background: #f0f4ff;
            border-color: #764ba2;
        }
        
        .upload-area.dragover {
            background: #e0e7ff;
            border-color: #764ba2;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .upload-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }
        
        .settings {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .value-display {
            text-align: center;
            color: #667eea;
            font-size: 18px;
            font-weight: bold;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress {
            display: none;
            margin-top: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .status {
            margin-top: 15px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        .audio-preview {
            display: none;
            margin-top: 20px;
        }
        
        audio {
            width: 100%;
            margin-top: 10px;
        }
        
        .info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ï¸ Ø§ÙØ²Ø§ÛŒØ´ ÙˆÙ‚ÙÙ‡â€ŒÙ‡Ø§ÛŒ ØµÙˆØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù„Ø§Ú¯ÙˆÛŒÛŒ</h1>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <p><strong>ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</strong></p>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">ÛŒØ§ ÙØ§ÛŒÙ„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯</p>
            <input type="file" id="fileInput" accept="audio/*">
        </div>
        
        <div class="settings">
            <label for="silenceMultiplier">Ø¶Ø±ÛŒØ¨ Ø§ÙØ²Ø§ÛŒØ´ ÙˆÙ‚ÙÙ‡â€ŒÙ‡Ø§:</label>
            <input type="range" id="silenceMultiplier" min="2" max="10" step="0.5" value="4">
            <div class="value-display"><span id="multiplierValue">4</span> Ø¨Ø±Ø§Ø¨Ø±</div>
        </div>
        
        <div class="settings">
            <label for="silenceThreshold">Ø­Ø³Ø§Ø³ÛŒØª ØªØ´Ø®ÛŒØµ Ø³Ú©ÙˆØª (dB):</label>
            <input type="range" id="silenceThreshold" min="-60" max="-20" step="1" value="-40">
            <div class="value-display"><span id="thresholdValue">-40</span> dB</div>
        </div>
        
        <button id="processBtn" disabled>Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„</button>
        
        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="status" id="status"></div>
        </div>
        
        <div class="audio-preview" id="audioPreview">
            <h3 style="color: #667eea; margin-bottom: 10px;">Ù†ØªÛŒØ¬Ù‡:</h3>
            <audio controls id="resultAudio"></audio>
            <button id="downloadBtn">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ MP3</button>
        </div>
        
        <div class="info">
            <strong>ğŸ“Œ Ù†Ú©Ø§Øª:</strong>
            <ul style="margin-right: 20px; margin-top: 10px;">
                <li>ÙÙ‚Ø· Ø³Ú©ÙˆØªâ€ŒÙ‡Ø§ (ÙˆÙ‚ÙÙ‡â€ŒÙ‡Ø§) Ø§ÙØ²Ø§ÛŒØ´ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ù†Ø¯</li>
                <li>Ù…Ø­ØªÙˆØ§ÛŒ Ú¯ÙØªØ§Ø±ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯</li>
                <li>Ø®Ø±ÙˆØ¬ÛŒ Ø¯Ø± ÙØ±Ù…Øª MP3 Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</li>
            </ul>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const processBtn = document.getElementById('processBtn');
        const progress = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const status = document.getElementById('status');
        const audioPreview = document.getElementById('audioPreview');
        const resultAudio = document.getElementById('resultAudio');
        const downloadBtn = document.getElementById('downloadBtn');
        const multiplierValue = document.getElementById('multiplierValue');
        const silenceMultiplier = document.getElementById('silenceMultiplier');
        const thresholdValue = document.getElementById('thresholdValue');
        const silenceThreshold = document.getElementById('silenceThreshold');

        let audioFile = null;
        let processedBlob = null;

        // Update slider values
        silenceMultiplier.addEventListener('input', (e) => {
            multiplierValue.textContent = e.target.value;
        });

        silenceThreshold.addEventListener('input', (e) => {
            thresholdValue.textContent = e.target.value;
        });

        // Upload area click
        uploadArea.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('audio/')) {
                alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }
            audioFile = file;
            uploadArea.querySelector('p').innerHTML = `<strong>âœ“ ${file.name}</strong>`;
            processBtn.disabled = false;
        }

        // Process button
        processBtn.addEventListener('click', async () => {
            if (!audioFile) return;

            processBtn.disabled = true;
            progress.style.display = 'block';
            audioPreview.style.display = 'none';

            try {
                await processAudio(audioFile);
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´: ' + error.message);
                console.error(error);
            } finally {
                processBtn.disabled = false;
            }
        });

        async function processAudio(file) {
            updateProgress(10, 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„...');

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuffer = await file.arrayBuffer();
            
            updateProgress(30, 'Ø¯Ø± Ø­Ø§Ù„ Ø±Ù…Ø²Ú¯Ø´Ø§ÛŒÛŒ ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ...');
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            updateProgress(50, 'Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆÙ‚ÙÙ‡â€ŒÙ‡Ø§...');
            const processedBuffer = await stretchSilences(audioBuffer, audioContext);

            updateProgress(70, 'Ø¯Ø± Ø­Ø§Ù„ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ MP3...');
            const mp3Blob = await encodeToMp3(processedBuffer, audioContext.sampleRate);

            updateProgress(90, 'Ø¯Ø± Ø­Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒâ€ŒØ³Ø§Ø²ÛŒ...');
            processedBlob = mp3Blob;

            // Show result
            const url = URL.createObjectURL(mp3Blob);
            resultAudio.src = url;
            audioPreview.style.display = 'block';

            updateProgress(100, 'Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ø§Ù…Ù„ Ø´Ø¯! âœ“');
            setTimeout(() => {
                progress.style.display = 'none';
            }, 2000);
        }

        async function stretchSilences(audioBuffer, audioContext) {
            const numberOfChannels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const threshold = Math.pow(10, parseFloat(silenceThreshold.value) / 20);
            const multiplier = parseFloat(silenceMultiplier.value);

            // Analyze audio to find silence regions
            const channelData = audioBuffer.getChannelData(0);
            const windowSize = Math.floor(sampleRate * 0.01); // 10ms windows
            const silenceRegions = [];

            for (let i = 0; i < channelData.length; i += windowSize) {
                const windowEnd = Math.min(i + windowSize, channelData.length);
                let sum = 0;
                
                for (let j = i; j < windowEnd; j++) {
                    sum += Math.abs(channelData[j]);
                }
                
                const avg = sum / (windowEnd - i);
                silenceRegions.push(avg < threshold);
            }

            // Calculate new buffer size
            let newLength = 0;
            for (let i = 0; i < silenceRegions.length; i++) {
                const windowLength = Math.min(windowSize, channelData.length - i * windowSize);
                newLength += silenceRegions[i] ? Math.floor(windowLength * multiplier) : windowLength;
            }

            // Create new buffer
            const newBuffer = audioContext.createBuffer(numberOfChannels, newLength, sampleRate);

            // Process each channel
            for (let channel = 0; channel < numberOfChannels; channel++) {
                const inputData = audioBuffer.getChannelData(channel);
                const outputData = newBuffer.getChannelData(channel);
                let outputIndex = 0;

                for (let i = 0; i < silenceRegions.length; i++) {
                    const windowStart = i * windowSize;
                    const windowEnd = Math.min(windowStart + windowSize, inputData.length);
                    const windowLength = windowEnd - windowStart;

                    if (silenceRegions[i]) {
                        // Stretch silence
                        const stretchedLength = Math.floor(windowLength * multiplier);
                        for (let j = 0; j < stretchedLength; j++) {
                            const sourceIndex = windowStart + Math.floor(j / multiplier);
                            outputData[outputIndex++] = inputData[sourceIndex];
                        }
                    } else {
                        // Copy non-silence as-is
                        for (let j = windowStart; j < windowEnd; j++) {
                            outputData[outputIndex++] = inputData[j];
                        }
                    }
                }
            }

            return newBuffer;
        }

        async function encodeToMp3(audioBuffer, sampleRate) {
            // Use lamejs for MP3 encoding
            const mp3encoder = new lamejs.Mp3Encoder(audioBuffer.numberOfChannels, sampleRate, 128);
            const samples = audioBuffer.getChannelData(0);
            const sampleBlockSize = 1152;
            const mp3Data = [];

            // Convert float samples to int16
            const int16Samples = new Int16Array(samples.length);
            for (let i = 0; i < samples.length; i++) {
                const s = Math.max(-1, Math.min(1, samples[i]));
                int16Samples[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }

            // Encode in blocks
            for (let i = 0; i < int16Samples.length; i += sampleBlockSize) {
                const sampleChunk = int16Samples.subarray(i, i + sampleBlockSize);
                const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
                if (mp3buf.length > 0) {
                    mp3Data.push(mp3buf);
                }
            }

            // Flush remaining data
            const mp3buf = mp3encoder.flush();
            if (mp3buf.length > 0) {
                mp3Data.push(mp3buf);
            }

            return new Blob(mp3Data, { type: 'audio/mp3' });
        }

        function updateProgress(percent, message) {
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
            status.textContent = message;
        }

        // Download button
        downloadBtn.addEventListener('click', () => {
            if (!processedBlob) return;

            const url = URL.createObjectURL(processedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dictation_' + Date.now() + '.mp3';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>

    <!-- Ù„Ø§ÛŒØ¨Ø±Ø±ÛŒ lamejs Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ MP3 -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
</body>
</html>
